name: ci

on:
  # 手动触发事件
  workflow_dispatch:
    inputs:
      enable:
        description: "启用或禁用自动 GitHub 自动全绿功能"
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - master
  schedule:
    # 每 15 分钟尝试触发一次，一天有 96 个 15 分钟的时间段
    - cron: "*/15 * * * *"

jobs:
  autogreen:
    runs-on: ubuntu-latest
    # 检查是否满足触发条件
    if: |
      (github.event_name == 'schedule' &&
        (
          "`expr ${{ github.run_number }} % 4`" == "0" ||
          "`expr ${{ github.run_number }} % 3`" == "0" ||
          "`expr ${{ github.run_number }} % 2`" == "0"
        )
      ) ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.enable == 'true')
    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Auto green to show 2024 in light green in 2024
        run: |
          set -e
          git config --local user.email ${{ secrets.EMAIL }}
          git config --local user.name ${{ secrets.NAME }}
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git pull --rebase
          # 2024 年 1 月 1 号作为起始日期
          start_date="2024-01-01"
          # 定义 2024 图案的日期偏移量，根据新布局调整
          offsets_2024=(
            # 数字 2 的偏移量
            1 2 3 9 16 23 30 37 44 51 58 65 72 79 86 93 100 107 114 121 128 135 142 149 156 163 170 177 184 191 198 205 212 219 226 233 240 247 254 261 268 275 282 289 296 303 310 317 324 331 338 345 352 359
            # 数字 0 的偏移量
            4 5 6 7 8 10 11 12 13 14 15 17 18 19 20 21 22 24 25 26 27 28 29 31 32 33 34 35 36 38 39 40 41 42 43 45 46 47 48 49 50 52 53 54 55 56 57 59 60 61 62 63 64 66 67 68 69 70 71 73 74 75 76 77 78 80 81 82 83 84 85 87 88 89 90 91 92 94 95 96 97 98 99 101 102 103 104 105 106 108 109 110 111 112 113 115 116 117 118 119 120 122 123 124 125 126 127 129 130 131 132 133 134 136 137 138 139 140 141 143 144 145 146 147 148 150 151 152 153 154 155 157 158 159 160 161 162 164 165 166 167 168 169 171 172 173 174 175 176 178 179 180 181 182 183 185 186 187 188 189 190 192 193 194 195 196 197 199 200 201 202 203 204 206 207 208 209 210 211 213 214 215 216 217 218 220 221 222 223 224 225 227 228 229 230 231 232 234 235 236 237 238 239 241 242 243 244 245 246 248 249 250 251 252 253 255 256 257 258 259 260 262 263 264 265 266 267 269 270 271 272 273 274 276 277 278 279 280 281 283 284 285 286 287 288 290 291 292 293 294 295 297 298 299 300 301 302 304 305 306 307 308 309 311 312 313 314 315 316 318 319 320 321 322 323 325 326
            # 数字 2 的偏移量（第二个 2）
            43 44 45 51 58 65 72 79 86 93 100 107 114 121 128 135 142 149 156 163 170 177 184 191 198 205 212 219 226 233 240 247 254 261 268 275 282 289 296 303 310 317 324 331 338 345 352 359
            # 数字 4 的偏移量
            46 47 48 55 62 69 76 83 90 97 104 111 118 125 132 139 146 153 160 167 174 181 188 195 202 209 216 223 230 237 244 251 258 265 272 279 286 293 300 307 314 321 328 335 342 349 356
          )
          # 设定 2024 区域的提交次数（低频率），增加到11次
          light_green_commits=11
          # 计算 2024 年的总天数
          total_days=366  # 2024 年是闰年
          for ((day = 0; day < total_days; day++)); do
            commit_date=$(date -d "$start_date + $day days" +'%Y-%m-%d %H:%M:%S')
            if printf '%s\n' "${offsets_2024[@]}" | grep -qx "$day"; then
              for ((i = 0; i < light_green_commits; i++)); do
                commit_message="Show 2024 in light green at $commit_date"
                GIT_COMMITTER_DATE="$commit_date" git commit --allow-empty -m "$commit_message" --date "$commit_date"
              done
            fi
          done
          git push    
