name: GitHub Heatmap - Random 2010-2020
on:
  workflow_dispatch:
    inputs:
      enable:
        description: "启用或禁用随机热力图生成"
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  random-heatmap:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.enable == 'true'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Random Heatmap (2010-2020)
        run: |
          set -e
          git config --local user.email "${{ secrets.EMAIL }}"
          git config --local user.name "${{ secrets.NAME }}"
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git pull --rebase --autostash

          # 定义时间范围
          start_year=2010
          end_year=2020

          # 生成随机提交
          generate_random_heatmap() {
            for year in $(seq $start_year $end_year); do
              # 计算当年天数
              days_in_year=365
              if [[ $year % 4 == 0 && ($year % 100 != 0 || $year % 400 == 0) ]]; then  # 修正条件表达式
                days_in_year=366
              fi

              # 遍历每一天
              for ((day=0; day<$days_in_year; day++)); do
                commit_date=$(date -d "$year-01-01 + $day days" +"%Y-%m-%dT09:00:00Z")
                # 生成随机提交次数（1-50次）
                commits=$((RANDOM % 50 + 1))
                
                echo "Generating $commits commits for $commit_date"
                for ((i=0; i<$commits; i++)); do
                  GIT_COMMITTER_DATE="$commit_date" git commit --allow-empty -m "Random Heatmap $year" --date "$commit_date"
                done
              done
            done
          }

          # 执行生成
          generate_random_heatmap
          git push --force-with-lease
